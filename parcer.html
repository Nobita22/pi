<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>hatsApp Chat Viewerrr</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { background: #ece5dd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 540px; margin: 36px auto; background: #fff; border-radius: 9px;
            box-shadow: 0 3px 17px #0001; overflow: hidden; }
        .header { background: #075e54; color: #fff; padding: 20px; font-size: 1.5em; text-align: center; }
        .chat-box { max-height: 640px; overflow-y: auto; padding: 20px 12px 12px 12px; background: #ece5dd; display: flex; flex-direction: column; }
        .message { margin: 10px 0; padding: 10px; border-radius: 7px; max-width: 85%; background: #dcf8c6;
            position: relative; box-shadow: 0 2px 8px #aaa2; word-break: break-word; min-width: 70px;}
        .message.me { background: #fff; border: 1px solid #dcf8c6; align-self: flex-end;}
        .name { font-size: .95em; font-weight: 600; color: #075e54; margin-bottom: 2px;}
        .time { color: #888; font-size: 0.78em; position: absolute; bottom: 6px; right: 16px;}
        .media { max-width: 94%; border-radius: 6px; margin: 10px 0; display: block;}
        .upload-section { padding: 20px; text-align: center;}
        .upload-section input[type='file'] { padding: 8px 0; }
        @media (max-width:600px) { .container{max-width:100vw;} }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <i class="fa-brands fa-whatsapp"></i> WhatsApp Chat Viewer
    </div>
    <div class="upload-section">
        <input type="file" id="zipInput" accept=".zip"/>
        <p style="font-size:0.96em;color:#555;">Select exported WhatsApp ZIP (with .txt & media)</p>
    </div>
    <div class="chat-box" id="chatBox" style="display:none;"></div>
</div>
<script>
    const zipInput = document.getElementById('zipInput');
    const chatBox = document.getElementById('chatBox');
    let mediaFiles = {};

    function escapeHtml(text) {
        return text.replace(/[&<>"']/g, m =>
            ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function detectAndParseLine(line) {
        // [mm/dd/yy, hh:mm] Name: Message
        let m = line.match(/^\[(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}), (\d{2}:\d{2})\] (.*?): (.*)$/);
        if (m) return {date: m[1], time: m[2], name: m[3], text: m[4]};
        // dd/mm/yyyy, hh:mm - Name: Message
        m = line.match(/^(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}), (\d{2}:\d{2}) - (.*?): (.*)$/);
        if (m) return {date: m[1], time: m[2], name: m[3], text: m[4]};
        return null;
    }

    async function handleZip(file) {
        const zip = await JSZip.loadAsync(file);
        let chatTextFile = null;
        mediaFiles = {};

        zip.forEach((relativePath, zipEntry) => {
            if (!chatTextFile && zipEntry.name.toLowerCase().endsWith('.txt') && !zipEntry.dir)
                chatTextFile = zipEntry;
            else if (zipEntry.name.match(/\.(jpg|jpeg|png|gif|mp4|opus|ogg|webm|mp3)$/i))
                mediaFiles[zipEntry.name.split('/').pop()] = zipEntry;
        });

        if (!chatTextFile) { alert('No chat text file found in ZIP!'); return; }
        const chatText = await chatTextFile.async('string');
        renderChat(chatText);
    }

    function findAndEmbedMedia(line, callback) {
        let found = false;
        // WhatsApp references media by filename in message line
        const mediaPat = /(?:attached|)(\S+\.(jpg|jpeg|png|gif|mp4|opus|ogg|webm|mp3))/i;
        let match = line.match(mediaPat);
        if (!match) { callback(escapeHtml(line)); return; }
        let filename = match[1] || match[0];
        let zipMedia = mediaFiles[filename];
        if (!zipMedia) { callback(escapeHtml(line)); return; }
        zipMedia.async('base64').then(base64 => {
            let ext = filename.split('.').pop().toLowerCase();
            let tag = '';
            if (['jpg','jpeg','png','gif'].includes(ext)) {
                tag = `<br><img class="media" src="data:image/${ext=='jpg'?'jpeg':ext};base64,${base64}">`;
            }
            else if (['mp4','webm'].includes(ext)) {
                tag = `<br><video class="media" controls><source src="data:video/${ext};base64,${base64}"></video>`;
            }
            else if (['opus','ogg','mp3'].includes(ext)) {
                tag = `<br><audio class="media" controls><source src="data:audio/${ext};base64,${base64}"></audio>`;
            }
            // Remove filename and insert tag
            callback(escapeHtml(line.replace(filename, '')).replace(/\s+$/, '') + tag);
        });
    }

    function renderChat(text) {
        chatBox.innerHTML = '';
        chatBox.style.display = 'flex';
        const lines = text.split(/\r?\n/);
        let index = 0;
        function processNext() {
            if (index >= lines.length) { chatBox.scrollTop = chatBox.scrollHeight; return; }
            let obj = detectAndParseLine(lines[index]);
            index++;
            if (!obj) { processNext(); return; }
            const isMe = /^(you|me)$/i.test(obj.name.trim());
            // Async media loader
            findAndEmbedMedia(obj.text, inner => {
                chatBox.innerHTML += `
                    <div class="message${isMe ? ' me' : ''}">
                        <div class="name">${escapeHtml(obj.name)}</div>
                        ${inner}
                        <span class="time">${escapeHtml(obj.time)}</span>
                    </div>`;
                processNext();
            });
        }
        processNext();
    }

    zipInput.addEventListener('change', e => {
        if (zipInput.files && zipInput.files[0]) {
            handleZip(zipInput.files[0]);
        }
    });
</script>
</body>
</html>
