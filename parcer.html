<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Chat Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- FontAwesome for icons (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: #ece5dd;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 550px;
            margin: 40px auto;
            background: #fff;
            border-radius: 9px;
            box-shadow: 0 3px 17px #0002;
            overflow: hidden;
        }
        .header {
            background: #075e54;
            color: #fff;
            padding: 20px;
            font-size: 1.5em;
            text-align: center;
        }
        .chat-box {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px 10px 10px 10px;
            background: #ece5dd;
        }
        .message {
            margin: 10px;
            padding: 10px;
            border-radius: 7px;
            max-width: 80%;
            background: #dcf8c6;
            box-shadow: 0 2px 8px #aaa2;
            position: relative;
            word-break: break-word;
        }
        .message.me {
            background: #fff;
            align-self: flex-end;
            border: 1px solid #dcf8c6;
        }
        .name {
            font-size: .9em;
            font-weight: 600;
            color: #075e54;
            margin-bottom: 2px;
        }
        .time {
            color: #888;
            font-size: 0.75em;
            position: absolute;
            bottom: 6px;
            right: 10px;
        }
        .media {
            max-width: 90%;
            border-radius: 5px;
            margin: 8px 0;
        }
        .upload-section {
            padding: 24px;
            text-align: center;
        }
        .upload-section input[type='file'] {
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <i class="fa-brands fa-whatsapp"></i> WhatsApp Chat Viewer
    </div>
    <div class="upload-section">
        <input type="file" id="zipInput" accept=".zip"/>
        <p style="font-size:0.96em;color:#555;">Select your exported WhatsApp ZIP file (with 'txt' chat and media)</p>
    </div>
    <div class="chat-box" id="chatBox" style="display:none;flex-direction:column;"></div>
</div>
<script>
    const zipInput = document.getElementById('zipInput');
    const chatBox = document.getElementById('chatBox');
    let mediaFiles = {};

    function escapeHtml(text) {
        return text.replace(/[&<>"']/g, m =>
            ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function parseMessageLine(line) {
        // Format: 01/08/2025, 18:57 - Name: Message
        const regex = /^(\d{1,2}\/\d{1,2}\/\d{2,4}), (\d{2}:\d{2}) - (.*?): (.*)$/;
        const match = line.match(regex);
        if (match) {
            return {
                date: match[10],
                time: match[9],
                name: match[11],
                text: match[12]
            };
        }
        return null;
    }

    async function handleZip(file) {
        const zip = await JSZip.loadAsync(file);
        let chatTextFile = null;
        mediaFiles = {};

        // Find txt and media
        zip.forEach((relativePath, zipEntry) => {
            if (zipEntry.name.match(/\.txt$/i)) {
                chatTextFile = zipEntry;
            } else if (zipEntry.name.match(/\.(jpg|jpeg|png|gif|mp4|opus|ogg|webm)$/i)) {
                // Store as media, indexed by filename for lookup later
                mediaFiles[zipEntry.name.split('/').pop()] = zipEntry;
            }
        });
        if (!chatTextFile) {
            alert('No chat .txt file found!');
            return;
        }
        const chatText = await chatTextFile.async('string');
        showChat(chatText);
    }

    function findMediaEmbed(match, done) {
        let clean = match.trim().replace(/^([>\- ]+)/, '');
        let name = Object.keys(mediaFiles).find(fn => clean.includes(fn));
        if (!name) return done(match);
        mediaFiles[name].async("base64").then(base64 => {
            let ext = name.split('.').pop().toLowerCase();
            let prefix;
            if (['jpg','jpeg','png','gif'].includes(ext))
                prefix = `data:image/${ext==='jpg'?'jpeg':ext};base64,`;
            else if (['mp4','webm'].includes(ext))
                prefix = `data:video/${ext};base64,`;
            else if (['opus','ogg','mp3'].includes(ext))
                prefix = `data:audio/${ext};base64,`;
            else return done(match);

            let mediaTag;
            if (prefix.startsWith('data:image')) {
                mediaTag = `<br/><img src="${prefix+base64}" class="media"/>`;
            } else if (prefix.startsWith('data:video')) {
                mediaTag = `<br/><video controls class="media"><source src="${prefix+base64}"></video>`;
            } else if (prefix.startsWith('data:audio')) {
                mediaTag = `<br/><audio controls class="media"><source src="${prefix+base64}"></audio>`;
            }
            done(mediaTag);
        });
    }

    function showChat(text) {
        chatBox.innerHTML = '';
        chatBox.style.display = 'flex';
        const lines = text.split(/\r?\n/);
        let lastName = '';
        let pending = 0;

        function appendMsg(obj, after) {
            const isMe = (obj.name.toLowerCase().includes('you') || obj.name.toLowerCase().includes('me'));
            let message = escapeHtml(obj.text);
            // Media
            let maybeMedia = /\S+\.(jpg|jpeg|png|gif|mp4|opus|ogg|webm|mp3)/i.exec(message);
            if (maybeMedia) {
                pending++;
                findMediaEmbed(maybeMedia, mediaHtml => {
                    message = message.replace(maybeMedia, mediaHtml);
                    chatBox.innerHTML += `
                        <div class="message${isMe ? ' me' : ''}">
                            <div class="name">${escapeHtml(obj.name)}</div>
                            ${message}
                            <span class="time">${obj.time}</span>
                        </div>
                    `;
                    pending--;
                    if (pending===0) chatBox.scrollTop = chatBox.scrollHeight;
                    if (after) after();
                });
                return;
            }
            chatBox.innerHTML += `
                <div class="message${isMe ? ' me' : ''}">
                    <div class="name">${escapeHtml(obj.name)}</div>
                    ${message}
                    <span class="time">${obj.time}</span>
                </div>
            `;
            if (after) after();
        }

        function processLine(i) {
            if (i >= lines.length) return;
            const obj = parseMessageLine(lines[i]);
            if (obj) appendMsg(obj, () => processLine(i+1));
            else processLine(i+1);
        }
        processLine(0);
    }

    zipInput.addEventListener('change', e => {
        if (zipInput.files && zipInput.files) {
            handleZip(zipInput.files);
        }
    });
</script>
</body>
</html>
